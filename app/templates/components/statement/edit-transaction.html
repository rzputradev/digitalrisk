<form method="POST" action="{{ url_for('platform.statement.edit_transaction') }}" aria-labelledby="formTitle">
   <div>
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
      <input type="hidden" name="statement_id" value="{{ statement.id }}" />
   </div>
   <!-- <h2 id="formTitle" class="text-lg font-bold">Edit Transactions</h2> -->
   <table id="transactionTable" class="table-auto w-full border-collapse text-base text-primary/80 text-left">
      <thead>
         <tr class="px-4 py-2 text-left">
            <th class="px-4 py-2">Transaction Date</th>
            <th class="px-4 py-2">Value Date</th>
            <th class="px-4 py-2">Description</th>
            <th class="px-4 py-2">Reference</th>
            <th class="px-4 py-2 text-right">Debit</th>
            <th class="px-4 py-2 text-right">Credit</th>
            <th class="px-4 py-2 text-right">Balance</th>
         </tr>
      </thead>
      <tbody id="transactionTableBody" class="divide-y divide-mutedForeground/20 text-left">
         {% for transaction in result.transactions %}
         <tr
            id="row_{{ transaction.id }}"
            class="transaction-row {{ 'new-row' if transaction.datetime.value == '' else '' }}"
         >
            <td
               class="px-4 py-3 truncate w-[200px]"
               data-confidence="{{ transaction.datetime.confidence }}"
               data-faulty="{{ transaction.datetime.faulty }}"
            >
               <label for="datetime_{{ transaction.id }}" class="sr-only">Transaction Date</label>
               <input
                  id="datetime_{{ transaction.id }}"
                  type="datetime-local"
                  name="transactions[{{ transaction.id }}][datetime]"
                  value="{{ transaction.datetime.value|replace(' ', 'T') }}"
                  class="w-full bg-inherit appearance-none focus:outline-none focus:ring-0"
                  aria-required="true"
                  required
               />
               <input
                  type="hidden"
                  name="transactions[{{ transaction.id }}][datetime_confidence]"
                  value="{{ transaction.datetime.confidence }}"
               />
               <input
                  type="hidden"
                  name="transactions[{{ transaction.id }}][datetime_faulty]"
                  value="{{ transaction.datetime.faulty }}"
               />
            </td>
            <td
               class="px-4 py-3 truncate w-[200px]"
               data-confidence="{{ transaction.valuedate.confidence }}"
               data-faulty="{{ transaction.valuedate.faulty }}"
            >
               <label for="valuedate_{{ transaction.id }}" class="sr-only">Value Date</label>
               <input
                  id="valuedate_{{ transaction.id }}"
                  type="datetime-local"
                  name="transactions[{{ transaction.id }}][valuedate]"
                  value="{{ transaction.valuedate.value|replace(' ', 'T') }}"
                  class="w-full bg-inherit appearance-none focus:outline-none focus:ring-0"
               />
               <input
                  type="hidden"
                  name="transactions[{{ transaction.id }}][valuedate_confidence]"
                  value="{{ transaction.valuedate.confidence }}"
               />
               <input
                  type="hidden"
                  name="transactions[{{ transaction.id }}][valuedate_faulty]"
                  value="{{ transaction.valuedate.faulty }}"
               />
            </td>
            <td
               class="px-4 py-3 truncate w-[200px]"
               data-confidence="{{ transaction.description.confidence }}"
               data-faulty="{{ transaction.description.faulty }}"
            >
               <label for="description_{{ transaction.id }}" class="sr-only">Description</label>
               <input
                  id="description_{{ transaction.id }}"
                  type="text"
                  name="transactions[{{ transaction.id }}][description]"
                  value="{{ transaction.description.value }}"
                  class="w-full bg-inherit appearance-none focus:outline-none focus:ring-0"
               />
               <input
                  type="hidden"
                  name="transactions[{{ transaction.id }}][description_confidence]"
                  value="{{ transaction.description.confidence }}"
               />
               <input
                  type="hidden"
                  name="transactions[{{ transaction.id }}][description_faulty]"
                  value="{{ transaction.description.faulty }}"
               />
            </td>
            <td
               class="px-4 py-3 truncate w-[200px]"
               data-confidence="{{ transaction.reference.confidence }}"
               data-faulty="{{ transaction.reference.faulty }}"
            >
               <label for="reference_{{ transaction.id }}" class="sr-only">Reference</label>
               <input
                  id="reference_{{ transaction.id }}"
                  type="text"
                  name="transactions[{{ transaction.id }}][reference]"
                  value="{{ transaction.reference.value }}"
                  class="w-full bg-inherit appearance-none focus:outline-none focus:ring-0"
               />
               <input
                  type="hidden"
                  name="transactions[{{ transaction.id }}][reference_confidence]"
                  value="{{ transaction.reference.confidence }}"
               />
               <input
                  type="hidden"
                  name="transactions[{{ transaction.id }}][reference_faulty]"
                  value="{{ transaction.reference.faulty }}"
               />
            </td>
            <td
               class="px-4 py-3 truncate w-[200px]"
               data-confidence="{{ transaction.debit.confidence }}"
               data-faulty="{{ transaction.debit.faulty }}"
            >
               <label for="debit_{{ transaction.id }}" class="sr-only">Debit</label>
               <input
                  id="debit_{{ transaction.id }}"
                  type="text"
                  name="transactions[{{ transaction.id }}][debit]"
                  value="{{ transaction.debit.value|comma_separation }}"
                  class="w-full bg-inherit text-right appearance-none focus:outline-none focus:ring-0"
               />
               <input
                  type="hidden"
                  name="transactions[{{ transaction.id }}][debit_confidence]"
                  value="{{ transaction.debit.confidence }}"
               />
               <input
                  type="hidden"
                  name="transactions[{{ transaction.id }}][debit_faulty]"
                  value="{{ transaction.debit.faulty }}"
               />
            </td>
            <td
               class="px-4 py-3 truncate w-[200px]"
               data-confidence="{{ transaction.credit.confidence }}"
               data-faulty="{{ transaction.credit.faulty }}"
            >
               <label for="credit_{{ transaction.id }}" class="sr-only">Credit</label>
               <input
                  id="credit_{{ transaction.id }}"
                  type="text"
                  name="transactions[{{ transaction.id }}][credit]"
                  value="{{ transaction.credit.value|comma_separation }}"
                  class="w-full bg-inherit text-right appearance-none focus:outline-none focus:ring-0"
               />
               <input
                  type="hidden"
                  name="transactions[{{ transaction.id }}][credit_confidence]"
                  value="{{ transaction.credit.confidence }}"
               />
               <input
                  type="hidden"
                  name="transactions[{{ transaction.id }}][credit_faulty]"
                  value="{{ transaction.credit.faulty }}"
               />
            </td>
            <td
               class="px-4 py-3 truncate w-[200px]"
               data-confidence="{{ transaction.balance.confidence }}"
               data-faulty="{{ transaction.balance.faulty }}"
            >
               <label for="balance_{{ transaction.id }}" class="sr-only">Balance</label>
               <input
                  id="balance_{{ transaction.id }}"
                  type="text"
                  name="transactions[{{ transaction.id }}][balance]"
                  value="{{ transaction.balance.value|comma_separation }}"
                  class="w-full bg-inherit text-right appearance-none focus:outline-none focus:ring-0"
                  aria-required="true"
                  required
               />
               <input
                  type="hidden"
                  name="transactions[{{ transaction.id }}][balance_confidence]"
                  value="{{ transaction.balance.confidence }}"
               />
               <input
                  type="hidden"
                  name="transactions[{{ transaction.id }}][balance_faulty]"
                  value="{{ transaction.balance.faulty }}"
               />
            </td>
         </tr>
         {% endfor %}
      </tbody>
   </table>

   <div class="flex justify-end p-4">
      <button
         type="submit"
         class="px-4 py-2 text-sm text-secondary bg-primary/85 hover:bg-primary/90 rounded-md font-semibold flex items-center gap-x-1"
      >
         Save
      </button>
   </div>
</form>

<div
   id="contextMenu"
   class="hidden absolute border bg-background shadow-lg rounded-md z-10"
   role="menu"
   aria-labelledby="contextMenuTitle"
>
   <h3 id="contextMenuTitle" class="sr-only">Context Menu</h3>
   <ul class="list-none m-0 p-0 text-sm">
      <li class="px-4 py-2 hover:bg-secondary" role="menuitem">
         <button id="addRow" class="flex gap-x-2">
            <svg
               xmlns="http://www.w3.org/2000/svg"
               width="24"
               height="24"
               viewBox="0 0 24 24"
               fill="none"
               stroke="currentColor"
               stroke-width="2"
               stroke-linecap="round"
               stroke-linejoin="round"
               class="feather feather-plus size-4"
            >
               <line x1="12" y1="5" x2="12" y2="19"></line>
               <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            <span>Add Row</span>
         </button>
      </li>
      <li class="px-4 py-2" role="menuitem">
         {% if result.transactions|length <= 1 %}
         <button id="deleteRow" class="flex gap-x-2 opacity-50" disabled>
            <svg
               xmlns="http://www.w3.org/2000/svg"
               width="24"
               height="24"
               viewBox="0 0 24 24"
               fill="none"
               stroke="currentColor"
               stroke-width="2"
               stroke-linecap="round"
               stroke-linejoin="round"
               class="feather feather-trash size-4 text-gray-400"
            >
               <polyline points="3 6 5 6 21 6"></polyline>
               <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
            <span class="text-gray-400">Delete Row</span>
         </button>
         {% else %}
         <button id="deleteRow" class="flex gap-x-2 hover:bg-secondary">
            <svg
               xmlns="http://www.w3.org/2000/svg"
               width="24"
               height="24"
               viewBox="0 0 24 24"
               fill="none"
               stroke="currentColor"
               stroke-width="2"
               stroke-linecap="round"
               stroke-linejoin="round"
               class="feather feather-trash size-4"
            >
               <polyline points="3 6 5 6 21 6"></polyline>
               <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
            <span>Delete Row</span>
         </button>
         {% endif %}
      </li>
   </ul>
</div>

<script>
   document.addEventListener("DOMContentLoaded", function () {
      const currencyInputs = document.querySelectorAll(
         'input[name$="[debit]"], input[name$="[credit]"], input[name$="[balance]"]'
      );

      function getBackgroundColor(confidence, faulty) {
         if (String(faulty).toLowerCase() === "true") {
            return "#ffdddd";
         }
         if (confidence == null || confidence >= 0.7) {
            return "";
         }
         const yellow = [255, 255, 90];
         const white = [255, 255, 255];
         const ratio = confidence / 0.7;
         const color = yellow.map((start, i) => Math.round(start + ratio * (white[i] - start)));
         return `rgb(${color[0]}, ${color[1]}, ${color[2]})`;
      }

      document.querySelectorAll("td[data-confidence]").forEach((cell) => {
         const confidence = parseFloat(cell.getAttribute("data-confidence"));
         const faulty = cell.getAttribute("data-faulty");
         cell.style.backgroundColor = getBackgroundColor(confidence, faulty);
      });

      function restrictCurrencyInput(e) {
         const allowedKeys = ["Backspace", "Delete", "ArrowLeft", "ArrowRight", "Tab"];
         if (!/^[0-9]$/.test(e.key) && !allowedKeys.includes(e.key)) {
            e.preventDefault();
         }
      }

      currencyInputs.forEach((input) => {
         input.addEventListener("input", function () {
            commaSeparation(input);
         });

         input.addEventListener("keydown", restrictCurrencyInput);
      });

      const contextMenu = document.getElementById("contextMenu");
      let currentRow;

      document.addEventListener("contextmenu", function (e) {
         if (e.target.closest(".transaction-row")) {
            e.preventDefault();
            currentRow = e.target.closest(".transaction-row");
            contextMenu.style.top = `${e.pageY}px`;
            contextMenu.style.left = `${e.pageX}px`;
            contextMenu.classList.remove("hidden");
         } else {
            contextMenu.classList.add("hidden");
         }
      });

      document.addEventListener("click", function (e) {
         if (!contextMenu.contains(e.target)) {
            contextMenu.classList.add("hidden");
         }
      });

      document.getElementById("addRow").addEventListener("click", function () {
         if (!currentRow) return;

         const rowCount = document.querySelectorAll(".transaction-row").length;
         const newId = rowCount;

         const newRow = document.createElement("tr");
         newRow.id = `row_${newId}`;
         newRow.className = "transaction-row new-row";

         function createCell(type, name, required = false) {
            const td = document.createElement("td");
            td.className = "px-4 py-3 truncate w-[200px]";

            const input = document.createElement("input");
            input.type = type;
            input.name = `transactions[${newId}][${name}]`;
            input.className = "w-full bg-inherit appearance-none focus:outline-none focus:ring-0 ";
            if (required) input.required = true;

            const confidenceInput = document.createElement("input");
            confidenceInput.type = "hidden";
            confidenceInput.name = `transactions[${newId}][${name}_confidence]`;
            confidenceInput.value = "1";

            const faultyInput = document.createElement("input");
            faultyInput.type = "hidden";
            faultyInput.name = `transactions[${newId}][${name}_faulty]`;
            faultyInput.value = false;

            td.appendChild(input);
            td.appendChild(confidenceInput);
            return td;
         }

         newRow.appendChild(createCell("datetime-local", "datetime", true));
         newRow.appendChild(createCell("datetime-local", "valuedate"));
         newRow.appendChild(createCell("text", "description"));
         newRow.appendChild(createCell("text", "reference"));
         newRow.appendChild(createCell("text", "debit"));
         newRow.appendChild(createCell("text", "credit"));
         newRow.appendChild(createCell("text", "balance", true));

         currentRow.insertAdjacentElement("afterend", newRow);

         updateRowIds();

         contextMenu.classList.add("hidden");
      });

      document.getElementById("deleteRow").addEventListener("click", function () {
         if (!currentRow) return;
         currentRow.remove();
         contextMenu.classList.add("hidden");
         updateRowIds();
      });

      function updateRowIds() {
         document.querySelectorAll(".transaction-row").forEach((row, index) => {
            const rowId = index;
            row.id = `row_${rowId}`;
            if (row.classList.contains("new-row")) {
               row.classList.remove("new-row");
            }
            const inputs = row.querySelectorAll("input[name^='transactions']");
            inputs.forEach((input) => {
               input.name = input.name.replace(/\[\d+\]/, `[${rowId}]`);
               const id = input.id;
               if (id) {
                  input.id = id.replace(/\d+$/, rowId);
               }
            });

            row.querySelectorAll('input[name$="[debit]"], input[name$="[credit]"], input[name$="[balance]"]').forEach(
               (input) => {
                  input.removeEventListener("input", commaSeparation);
                  input.removeEventListener("keydown", restrictCurrencyInput);

                  input.addEventListener("input", function () {
                     commaSeparation(input);
                  });

                  input.addEventListener("keydown", restrictCurrencyInput);
               }
            );
         });
      }
   });
</script>
